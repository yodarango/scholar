import React from "react";
import styles from "./image_from_verse_editor.module.css";
import Portal from "../../hoc/potal";
import { CloseContent } from "../../fragments/buttons/close_content";
import { RoundLoader } from "../../fragments/chunks/round_loader";
import { Header } from "../../fragments/Typography/header";
import { Primary } from "../../fragments/buttons/primary";
import { Error } from "../../common/feedback/error";
import { Parragraph } from "../../fragments/Typography/parragraph";
import { FONT_COLOR, PRIMARY_COLOR } from "../../../constants/tokens";
import { useKeepImageToVerse } from "../../../helpers/functions/reading/use_keep_image_to_verse";

type TImageFromVerseEditorProps = {
   ID: string;
   img_url: string;
   prompt?: string;
   VERSE_ID: string;
   verseContent: string;
   onClose: () => void;
   onTryAgain: (VERSE_ID: string) => void;
   loading: boolean;
   error: boolean;
   verseCitation: string;
};

export const ImageFromVerseEditor = ({
   loading,
   img_url,
   ID,
   VERSE_ID,
   onTryAgain,
   prompt,
   error,
   verseCitation,
   verseContent,
   onClose
}: TImageFromVerseEditorProps) => {
   const handleDownload = () => {
      const link = document.createElement("a");
      link.href = `data:image/png;base64, ${img_url}`;
      link.download = "image.png";
      link.click();
   };

   const handleTryAgain = () => {
      onTryAgain(VERSE_ID);
   };

   const handleKeepImage = () => {
      useKeepImageToVerse({ VERSE_ID, image: img_url });
   };

   return (
      <Portal>
         <div className={styles.mainWrapper}>
            <div className={styles.close}>
               <CloseContent cta={{ handleClick: onClose }} />
            </div>
            {!loading && !error && (
               <>
                  <div className={styles.imageWrapper}>
                     <Header
                        text={`Hooray! here is what ${verseCitation} created`}
                        size='main'
                        type={2}
                     />
                     <Parragraph text={verseContent} size='main' />
                     <img
                        src={`data:image/png;base64, ${img_url}`}
                        alt='generated by AI'
                        className={styles.image}
                     />
                  </div>
                  <div className={styles.buttons}>
                     <Primary cta={{ handleClick: handleDownload }} title='Download' type='1' />
                     <Primary
                        cta={{ handleClick: handleKeepImage }}
                        title='Keep'
                        customColor={{ text: PRIMARY_COLOR, button: FONT_COLOR }}
                     />
                     <Primary cta={{ handleClick: handleTryAgain }} title='Try again' type='2' />
                  </div>
               </>
            )}
            {loading && !error && (
               <div className={styles.loader}>
                  <RoundLoader />
               </div>
            )}
            {error && !loading && (
               <div className={styles.loader}>
                  <Error />
               </div>
            )}
         </div>
      </Portal>
   );
};
